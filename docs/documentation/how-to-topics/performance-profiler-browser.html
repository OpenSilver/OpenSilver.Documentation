<!DOCTYPE html>
<!--[if IE]><![endif]-->
<html>
  
  <head>
    <meta charset="utf-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge,chrome=1">
    <title>Use Browser to profile OpenSilver applications </title>
    <meta name="viewport" content="width=device-width">
    <meta name="title" content="Use Browser to profile OpenSilver applications ">
    <meta name="generator" content="docfx 2.59.4.0">
    
    <link rel="shortcut icon" href="../../favicon.ico">
    <link rel="stylesheet" href="../../styles/docfx.vendor.css">
    <link rel="stylesheet" href="../../styles/docfx.css">
    <link rel="stylesheet" href="../../styles/main.css">
    <meta property="docfx:navrel" content="../../toc.html">
    <meta property="docfx:tocrel" content="../../fusion/toc.html">
    
    
    
  </head>
  <body data-spy="scroll" data-target="#affix" data-offset="120">
    <div id="wrapper">
      <div class="header-top">
        
        <header id="header">
                    <div class="wrapper">
                        <div class="header_in">
                            <div id="hamb_menu" class="hamb show_sm"></div>
                            <a class="logo" href="https://opensilver.net/">
                                <img src="/images/OpenSilver-3.1-Logo-MidRes.png">
                            </a>
                            <!--<nav class="hide_sm">
                                <ul>
                                    <li><a href="https://opensilver.net/download.aspx">Download</a></li>
                                    <li><a href="/documentation/general/overview.html">Doc</a></li>
                                    <li><a href="https://opensilver.net/gallery">Gallery</a></li>
                                    <li><a href="https://opensilver.net/gallery#success-stories">Success Stories</a></li>
        
                                    <li><a href="https://opensilver.net/links/whatsnew.aspx">What's New</a></li>
                                    <li><a href="https://opensilver.net/contact.aspx">Contact</a></li>
                                    <li id="nav_more">More...</li>
                                </ul>
                            </nav>
        
                            <div class="header_UserSignin">
                                <p id="UserInformations"></p>
        
                            </div>-->
                        </div>
                    </div>
                    <!--<div class="additional_nav_out">
                        <div id="close_nav" class="close_btn hide_sm"></div>
                        <div class="wrapper">
        
                            <div class="additional_nav">
                                <div class="additional_nav-col">
                                    <h4>Product:</h4>
                                    <ul>
                                        <li><a href="https://opensilver.net/download.aspx">Download </a></li>
                                        <li><a href="/documentation/general/overview.html">Documentation</a></li>
                                        <li><a href="https://opensilver.net/gallery/"</a></li>
                                        <li><a href="https://opensilver.net/gallery#success-stories">Success Stories</a></li>
                                        <li><a href="https://opensilver.net/links/whatsnew.aspx">What's New</a></li>
                                        <li><a href="https://github.com/OpenSilver/OpenSilver">Source code on GitHub</a></li>
                                        <li><a href="https://opensilver.net/">Home</a></li>
                                    </ul>
                                </div>
                                <div class="additional_nav-col">
                                    <h4>Services:</h4>
                                    <ul>
                                        <li><a href="https://opensilver.net/links/migration-package.aspx">SL Migration Package</a></li>
                                        <li><a href="https://opensilver.net/migrate/upload-xap.aspx">Upload Your .XAP</a></li>
        
                                    </ul>
                                </div>
        
                                <div class="additional_nav-col">
                                    <h4>Company:</h4>
                                    <ul>
        
                                        <li><a href="https://opensilver.net/contact.aspx">Contact</a></li>
                                    </ul>
                                </div>
                                <div class="additional_nav-col social">
                                    <a class="additional_nav-social" href="https://twitter.com/OpenSilverTeam">
                                        <img src="/images/follow-us-on-twitter-light.png">
                                        <small>follow us on</small>
                                        twitter
                                    </a>
        
                                    <a class="additional_nav-social" href="https://github.com/OpenSilver/OpenSilver">
                                        <img src="/images/follow-us-on-github-light.png">
                                        <small>view source on</small>
                                        GitHub
                                    </a>
                                </div>
                            </div>
                        </div>
                    </div>-->
                </header>
        
        <div class="subnav navbar navbar-default">
          <div class="container hide-when-search" id="breadcrumb">
            <ul class="breadcrumb">
              <li></li>
            </ul>
          </div>
        </div>
      </div>
      <div role="main" class="container body-content hide-when-search">
        
        <div class="sidenav hide-when-search">
          <a class="btn toc-toggle collapse" data-toggle="collapse" href="#sidetoggle" aria-expanded="false" aria-controls="sidetoggle">Show / Hide Table of Contents</a>
          <div class="sidetoggle collapse" id="sidetoggle">
            <div id="sidetoc"></div>
          </div>
        </div>
        <div class="article row grid-right">
          <div class="col-md-8">
            <article class="content wrap" id="_content" data-uid="">
<h2 id="use-browser-to-profile-opensilver-applications">Use Browser to profile OpenSilver applications</h2>

<p><strong>Visual Studio</strong> provides different built-in tools for profiling and analysing performance including CPU and memory usage of applications. <a href="https://doc.opensilver.net/documentation/how-to-topics/performance-profiler.html">Here</a> is how to use it in the Simulator project.</p>
<p>However, for technical reasons we can use it only in <strong>Simulator</strong>. While it will provide a generic idea about performance and heavy running parts, the end goal is to run the applications in Browser and some routines can be slightly different when running on Browser.</p>
<h3 id="profiling-in-google-chrome">Profiling in Google Chrome</h3>
<p>All well known Browsers have built-in performance profiler. For this post we are going to use <strong>Google Chrome</strong>.</p>
<p>Running the profiler in Chrome is straightforward - just open <strong>Developer tools (Ctrl + Shift + I)</strong> and navigate to the <strong>Performance</strong> tab. Now we can use either <strong>Reload</strong> button to profile application initial load performance or <strong>Record</strong> button to start/stop profiling as we need to.</p>
<p><img src="/images/how-to-topics/profiling_1.png" alt="Google Chrome Profiler"><br></p>
<p>Here is an example of how the result looks like. It shows how much time is spent on Scripting, Rendering etc. And of course it is possible to zoom-in and see detailed information about each particular function.
<br></p>
<p><img src="/images/how-to-topics/profiler_result.png" alt="Profiler Result"><br></p>
<h3 id="decode-wasm-function---aot">Decode <strong>wasm-function</strong> - AOT</h3>
<p>One of the challenges that <strong>OpenSilver</strong> and <strong>Blazor</strong> applications face is we don't see the C# method names in profiler result but instead a lot of wasm-function's with corresponding numbers.</p>
<p><img src="/images/how-to-topics/wasm-function.png" alt="Google Chrome Profiler" width="700"><br></p>
<p>The reason is the method names are stripped during compilation to make binary (dotnet.wasm) smaller.</p>
<p>In <strong>AOT</strong> mode there are 2 ways to know which particular method corresponds to which number.</p>
<h4 id="1-wasmnativestrip">1. WasmNativeStrip</h4>
<p>The property tells the compiler to not strip method names.</p>
<pre><code>&lt;PropertyGroup&gt;
  ...
  &lt;WasmNativeStrip&gt;false&lt;/WasmNativeStrip&gt;
  ...
&lt;/PropertyGroup&gt;
</code></pre>
<p><strong>WasmNativeStrip</strong> is available in .NET6 and .NET7 and works only in AOT mode.</p>
<p>Here is how the result looks like.</p>
<p><img src="/images/how-to-topics/wasm-strip.png" alt="WasmNativeStrip"><br></p>
<p>Please note that this will make the binary size almost twice bigger because the function names are constructed using full namespace names.</p>
<p><code>OpenSilver.System.Windows.UIElement.Measure.System.Windows.Size -&gt; OpenSilver_System_Windows_UIElement_Measure_System_Windows_Size</code></p>
<h4 id="2-wasmemitsymbolmap">2. WasmEmitSymbolMap</h4>
<p>The property tells the compiler to generate a <code>dotnet.js.symbols</code> file where corresponding method names are listed. This property is more convenient to use in production, because it doesn't have any impact on binary size and <code>dotnet.js.symbols</code> can be just ignored if not needed. So the property can always be enabled.</p>
<pre><code>&lt;PropertyGroup&gt;
  ...
  &lt;WasmEmitSymbolMap&gt;true&lt;/WasmEmitSymbolMap&gt;
  ...
&lt;/PropertyGroup&gt;
</code></pre>
<p><strong>WasmEmitSymbolMap</strong> is available starting from <strong>.NET7 Preview 5</strong> and works only in AOT mode.</p>
<p><img src="/images/how-to-topics/symbols.png" alt="WasmEmitSymbolMap"><br></p>
<h4 id="replacing-wasm-function-with-corresponding-methods-in-profiler-result">Replacing wasm-function with corresponding methods in profiler result</h4>
<p>It might be inconvenient to use <b>WasmNativeStrip</b> for just profiling, taking into account AOT build time. But it is more inconvenient to check the function number then go and check the method name in <code>dotnet.js.symbols</code>. Fortunately Google Chrome allows to save profiling data as a json file and then load it back. (Right click -&gt; Save profile.../Load profile...).</p>
<p>That means we can save the profiling data, replace wasm-function's with method names with a simple script and load it back.</p>
<p>Here is a simple C# code which will handle it.</p>
<pre><code>Dictionary&lt;string, string&gt; funcs = new Dictionary&lt;string, string&gt;();
private readonly string symbols = @&quot;C:\Users\ashot\Desktop\dotnet.js.symbols&quot;;
private readonly string profile_json = @&quot;C:\Users\ashot\Desktop\Profile-20220628T182534.json&quot;;
private readonly string result_json = @&quot;C:\Users\ashot\Desktop\Profile-20220628T182534_1.json&quot;;

private void ReplaceWasmFunction()
{
    using (var reader = new StreamReader(symbols))
    {
        while (!reader.EndOfStream)
        {
            var s = reader.ReadLine();

            string num = s.Substring(0, s.IndexOf(&quot;:&quot;));
            string func = s.Substring(s.IndexOf(&quot;:&quot;) + 1, s.Length - num.Length - 1).Replace(&quot;\\&quot;, &quot;\\\\&quot;);
            funcs.Add(num, func);
        }
    }

    using (var reader = new StreamReader(profile_json))
    {
        string content = reader.ReadToEnd();
        content = Regex.Replace(content, @&quot;wasm-function\[.*?\]&quot;, 
		    m =&gt; funcs[m.Value.Substring(14, m.Value.Length - 14 - 1)]);
        using (var writer = new StreamWriter(result_json))
        {
            writer.Write(content);
        }
    }
}
</code></pre>
<h3 id="decode-wasm-function---non-aot">Decode <strong>wasm-function</strong> - NON-AOT</h3>
<p>It would be much convenient to be able to decode <code>wasm-function's</code> in non-aot mode, since AOT build takes a lot of time.</p>
<p>But is it possible? The short answer is <strong>NO</strong>.</p>
<p>When running in interprated mode, only mono runtime is compiled to WebAssembly and the C# methods are just being executed by runtime.</p>
<p>Let's assume we have a method Measure</p>
<pre><code>public void Measure(Size availableSize)
{
	...
}
</code></pre>
<p>What happens when the method is executed is this (very roughly).</p>
<pre><code>interp_exec_method(&quot;Measure&quot;, width, height);
</code></pre>
<p>So the profiler can see that there is a <code>interp_exec_method</code> function call but the C# method is just an argument and the way mono runtime executes it depends on implementation.</p>
<p>In fact <strong>.NET 7 Preview 5</strong> provides <code>dotnet.js.symbols</code> under <code>C:\Program Files\dotnet\packs\Microsoft.NETCore.App.Runtime.Mono.browser-wasm\7.0.0-preview.5.22301.12\runtimes\browser-wasm\native</code> which provides <code>wasm-function</code> numbers corresponding to mono runtime.</p>
<p>Using the above mentioned method we can decode wasm-functions and see what they represent.</p>
<p>As it can be seen, ~97% of activity is <strong>interp_exec_method</strong></p>
<p><img src="/images/how-to-topics/non-aot-profile.png" alt="Non AOT"><br></p>
</article>
          </div>
          
          <div class="hidden-sm col-md-2" role="complementary">
            <div class="sideaffix">
              <div class="contribution">
                <ul class="nav">
                  <li>
                    <a href="https://github.com/OpenSilver/OpenSilver.Documentation/blob/master/documentation/how-to-topics/performance-profiler-browser.md/#L1" class="contribution-link">Improve this Doc</a>
                  </li>
                </ul>
              </div>
              <nav class="bs-docs-sidebar hidden-print hidden-xs hidden-sm affix" id="affix">
              <!-- <p><a class="back-to-top" href="#top">Back to top</a><p> -->
              </nav>
            </div>
          </div>
        </div>
      </div>
          </div>
    
    <script type="text/javascript" src="../../styles/docfx.vendor.js"></script>
    <script type="text/javascript" src="../../styles/docfx.js"></script>
    <script type="text/javascript" src="../../styles/main.js"></script>
  </body>
</html>
